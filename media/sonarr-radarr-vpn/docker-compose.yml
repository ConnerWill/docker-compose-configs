---
services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      ## All
      - TZ=${TZ:-America/Chicago}

      ## Gluetun
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - FIREWALL_INPUT_PORTS=${FIREWALL_INPUT_PORTS:-7878,8989,9696,8686,8080,8191}  # Allow inbound access to published ports from LAN
      # - FIREWALL_OUTBOUND_SUBNETS=${FIREWALL_OUTBOUND_SUBNETS:-192.168.0.0/24}  # Only needed if VPN'd containers must reach LAN services

      ## Mullvad
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER:-mullvad}
      - VPN_TYPE=${VPN_TYPE:-wireguard}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY:?Wireguard private key is required}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES:?Wireguard addresses are required}
      - SERVER_CITIES=${SERVER_CITIES:-Toronto}

      ## Private Internet Access
      # - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER:-private internet access}
      # - OPENVPN_USER=${OPENVPN_USER:?OpenVPN user is required}
      # - OPENVPN_PASSWORD=${OPENVPN_PASSWORD:?OpenVPN password is required}
      # - SERVER_REGIONS=${SERVER_REGIONS:-Netherlands}
      # - PORT_FORWARD_ONLY=${PORT_FORWARD_ONLY:-true}
      # - PRIVATE_INTERNET_ACCESS_OPENVPN_ENCRYPTION_PRESET=${PRIVATE_INTERNET_ACCESS_OPENVPN_ENCRYPTION_PRESET:-strong}
      # - VPN_PORT_FORWARDING=${VPN_PORT_FORWARDING:-on}

      ## AirVPN
      # - VPN_TYPE=${VPN_TYPE:-wireguard}
      # - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY:?Wireguard private key is required}
      # - WIREGUARD_PRESHARED_KEY=${WIREGUARD_PRESHARED_KEY:?Wireguard preshared key is required}
      # - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES:?Wireguard addresses are required}
      # - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Canada}
      # - SERVER_CITIES=${SERVER_CITIES:-Toronto}
      # - SERVER_REGIONS=${SERVER_REGIONS:?Server regions not set}

    volumes:
      - gluetun:/gluetun
    ports:
      - "7878:7878/tcp"  # Radarr UI/API
      - "8080:8080/tcp"  # qBittorrent Web UI (optional; remove if you don't want it exposed)
      - "8191:8191/tcp"  # FlareSolverr
      - "8686:8686/tcp"  # Lidarr UI/API
      - "8988:8000/tcp"  # Tunarr UI/API
      - "8989:8989/tcp"  # Sonarr UI/API
      - "9696:9696/tcp"  # Prowlarr UI/API
    ## Optional: pin DNS to avoid “host not found” tracker failures
    # dns:
    #   - 1.1.1.1
    #   - 1.0.0.1
    healthcheck:
      # TODO: Confirm wget exists on gluetun image and this does not fail
      test: ["CMD-SHELL", "wget -qO- https://ipinfo.io/ip >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent_config:/config
      - ${DOWNLOADS_ROOT}:/downloads
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - radarr_config:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/documentaries:/documentaries
      - ${DOWNLOADS_ROOT}:/downloads
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - sonarr_config:/config
      - ${MEDIA_ROOT}/shows:/tv
      - ${MEDIA_ROOT}/documentaries:/documentaries
      - ${DOWNLOADS_ROOT}:/downloads
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - lidarr_config:/config
      - ${MEDIA_ROOT}/music:/music
      - ${DOWNLOADS_ROOT}:/downloads
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    volumes:
      - prowlarr_config:/config
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    network_mode: "service:gluetun"
    environment:
      - TZ=${TZ:-America/Chicago}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

  tunarr:
    image: ghcr.io/chrisbenincasa/tunarr:1.1.15
    container_name: tunarr
    # TODO: Confirm we want to go through gluetun
    # ports:
    #   - ${TUNARR_SERVER_PORT:-8988}:8000
    network_mode: "service_gluetun"  # TODO: Confirm we want to go through gluetun
    environment:
      - TZ=${TZ:-America/Chicago}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - tunarr_config:/config/tunarr
    restart: unless-stopped
    # TODO: Confirm we want to go through gluetun
    depends_on:
      gluetun:
        condition: service_healthy

volumes:
  gluetun:
  lidarr_config:
  prowlarr_config:
  qbittorrent_config:
  radarr_config:
  sonarr_config:
  tunarr_config:
